name: Build Multi-Platform Release

on:
  workflow_dispatch: # Activaci√≥n manual desde GitHub Actions

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            runner: windows-latest
            rid: win-x64
            extension: .exe
          - os: linux
            runner: ubuntu-latest
            rid: linux-x64
            extension: ""
          - os: macos
            runner: macos-latest
            rid: osx-x64
            extension: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish self-contained executable
        shell: bash
        run: |
          dotnet publish NBodiesSim/NBodiesSim.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o output/${{ matrix.os }}

      - name: Copy Data folder
        shell: bash
        run: |
          mkdir -p output/${{ matrix.os }}/Data
          cp NBodiesSim/Data/astrosData.json output/${{ matrix.os }}/Data/
          cp NBodiesSim/Data/astrosConfig.json output/${{ matrix.os }}/Data/

      - name: Create README
        shell: bash
        run: |
          cat > output/${{ matrix.os }}/README.txt << 'EOF'
          ========================================
          N-Bodies Simulator - Solar System
          ========================================

          INSTRUCCIONES:

          1. Aseg√∫rate de que la carpeta "Data" est√° en el mismo directorio que el ejecutable
          2. Ejecuta el programa:
             - Windows: Doble clic en NBodiesSim.exe
             - Linux/macOS: ./NBodiesSim (puede requerir: chmod +x NBodiesSim)

          CONTROLES:

          - ESPACIO: Vista general del sistema solar
          - 0-9: Seleccionar planeta/astro
          - ESC: Salir

          NOTA: Los archivos Data/astrosData.json y Data/astrosConfig.json contienen las posiciones,
          velocidades iniciales y configuraciones de todos los cuerpos celestes. Puedes editarlos
          para modificar la simulaci√≥n.

          Timesteps usados (n = substeps de integraci√≥n RK4):
          - Vista general: 1 d√≠a (86400s), n=300
          - Sol: 1 d√≠a (86400s), n=300
          - Mercurio: 1 hora (3600s), n=300
          - Venus: 1 hora (3600s), n=300
          - Tierra: 1 hora (3600s), n=300
          - Marte: 400 segundos (~7 min), n=300
          - J√∫piter: 30 minutos (1800s), n=300
          - Saturno: 30 minutos (1800s), n=300
          - Urano: 1 hora (3600s), n=300
          - Neptuno: 1 hora (3600s), n=300

          OPTIMIZACIONES (v1.2):
          - Trazas orbitales optimizadas: 1.5-3 √≥rbitas seg√∫n distancia
          - Bug cr√≠tico corregido: colas de trazas ahora se limpian correctamente
          - Rendimiento estable: 60 FPS incluso despu√©s de horas de simulaci√≥n
          - Posiciones de Fobos/Deimos corregidas: ahora orbitan correctamente con f√≠sica N-body
          - Monitor de error acumulado de energ√≠a para verificaci√≥n de estabilidad a largo plazo

          ========================================
          EOF

      - name: Create ZIP package
        shell: bash
        run: |
          cd output/${{ matrix.os }}
          if [ "${{ matrix.os }}" = "windows" ]; then
            7z a -tzip ../../NBodiesSim-${{ matrix.os }}.zip *
          else
            zip -r ../../NBodiesSim-${{ matrix.os }}.zip *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NBodiesSim-${{ matrix.os }}
          path: NBodiesSim-${{ matrix.os }}.zip
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate version tag
        id: version
        run: echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # N-Bodies Simulator - Solar System

          Simulaci√≥n gravitatoria N-cuerpos del Sistema Solar con f√≠sica realista.

          ## üì¶ Descargas

          Descarga el archivo correspondiente a tu sistema operativo:

          - **Windows**: `NBodiesSim-windows.zip`
          - **Linux**: `NBodiesSim-linux.zip`
          - **macOS**: `NBodiesSim-macos.zip`

          ## üöÄ Instalaci√≥n

          ### Windows
          1. Descarga y extrae el ZIP
          2. Ejecuta `NBodiesSim.exe`

          ### Linux
          1. Descarga y extrae: `unzip NBodiesSim-linux.zip`
          2. Da permisos: `chmod +x NBodiesSim`
          3. Ejecuta: `./NBodiesSim`

          ### macOS
          1. Descarga y extrae el ZIP
          2. Da permisos: `chmod +x NBodiesSim`
          3. Ejecuta: `./NBodiesSim`
          4. Si macOS bloquea: Preferencias del Sistema > Privacidad y Seguridad > "Abrir de todas formas"

          ## üéÆ Controles

          - **ESPACIO**: Vista general del sistema solar
          - **0-9**: Seleccionar planeta (0=Sol, 1=Mercurio, 2=Venus, etc.)
          - **ESC**: Salir

          ## ‚öôÔ∏è Caracter√≠sticas

          - ‚úÖ 8 planetas + Sol + objetos del Cintur√≥n de Kuiper
          - ‚úÖ 13+ sat√©lites naturales (Luna, Galileanos, Tit√°n, etc.)
          - ‚úÖ F√≠sica gravitatoria N-cuerpos completa con Runge-Kutta 4 (RK4)
          - ‚úÖ Anillos planetarios (Saturno, Urano, Neptuno)
          - ‚úÖ Cintur√≥n de asteroides y cintur√≥n de Kuiper
          - ‚úÖ Trazas orbitales optimizadas (1.5-3 √≥rbitas) con gradiente de transparencia
          - ‚úÖ Timesteps adaptativos seg√∫n el cuerpo observado
          - ‚úÖ Monitor de conservaci√≥n de energ√≠a con error acumulado en tiempo real
          - ‚úÖ 10,000 estrellas de fondo generadas proceduralmente
          - ‚úÖ Rendimiento optimizado: 60 FPS estables incluso despu√©s de horas

          ## üî• Mejoras Recientes (v1.2)

          - **Bug cr√≠tico corregido (v1.1)**: Colas de trazas ahora se limpian correctamente (eliminaba solo 1 punto/frame)
          - **Sin degradaci√≥n de FPS**: Mantiene 60 FPS estables durante toda la sesi√≥n
          - **Trazas optimizadas**: 25-40% menos puntos sin perder capacidad de ver perturbaciones orbitales
          - **Sat√©lites de Marte corregidos**: Posiciones de Fobos y Deimos corregidas (estaban 10x m√°s cerca)
          - **√ìrbitas estables**: Todos los cuerpos usan f√≠sica N-body completa con timesteps optimizados
          - **Monitoreo mejorado**: Error acumulado de energ√≠a para verificaci√≥n de estabilidad a largo plazo

          ## ‚ö†Ô∏è Problemas Conocidos

          - Quaoar puede mostrar deriva orbital leve en el Cintur√≥n de Kuiper (timestep grande + gravedad solar d√©bil a 43 AU)
          - Impacto visual √∫nicamente, sistema solar interior no afectado

          ## üìã Requisitos

          - **Windows**: Windows 10/11 (64-bit)
          - **Linux**: GLIBC 2.31+ y drivers OpenGL
          - **macOS**: macOS 10.15+ (Catalina o superior)

          ## üìù Notas

          - Cada ejecutable incluye el runtime de .NET (~70 MB)
          - No requiere instalaci√≥n de dependencias
          - Los archivos `Data/astrosData.json` y `Data/astrosConfig.json` contienen los par√°metros orbitales y configuraciones de c√°mara
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/NBodiesSim-windows/NBodiesSim-windows.zip
            artifacts/NBodiesSim-linux/NBodiesSim-linux.zip
            artifacts/NBodiesSim-macos/NBodiesSim-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
