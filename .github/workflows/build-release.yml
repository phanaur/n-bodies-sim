name: Build Multi-Platform Release

on:
  workflow_dispatch: # ActivaciÃ³n manual desde GitHub Actions

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            runner: windows-latest
            rid: win-x64
            extension: .exe
          - os: linux
            runner: ubuntu-latest
            rid: linux-x64
            extension: ""
          - os: macos
            runner: macos-latest
            rid: osx-x64
            extension: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish self-contained executable
        shell: bash
        run: |
          dotnet publish N-bodies-sim/N-bodies-sim.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o output/${{ matrix.os }}

      - name: Copy Data folder
        shell: bash
        run: |
          mkdir -p output/${{ matrix.os }}/Data
          cp N-bodies-sim/Data/astros.json output/${{ matrix.os }}/Data/

      - name: Create README
        shell: bash
        run: |
          cat > output/${{ matrix.os }}/README.txt << 'EOF'
          ========================================
          N-Bodies Simulator - Solar System
          ========================================

          INSTRUCCIONES:

          1. AsegÃºrate de que la carpeta "Data" estÃ¡ en el mismo directorio que el ejecutable
          2. Ejecuta el programa:
             - Windows: Doble clic en N-bodies-sim.exe
             - Linux/macOS: ./N-bodies-sim (puede requerir: chmod +x N-bodies-sim)

          CONTROLES:

          - ESPACIO: Vista general del sistema solar
          - 0-9: Seleccionar planeta/astro
          - ESC: Salir

          NOTA: El archivo Data/astros.json contiene las posiciones y velocidades iniciales
          de todos los cuerpos celestes. Puedes editarlo para modificar la simulaciÃ³n.

          Timesteps usados (n = substeps de integraciÃ³n):
          - Vista general: 1 dÃ­a, 1000 substeps
          - Mercurio: 1 hora, 5000 substeps
          - Venus-Marte: 1 hora, 5000 substeps
          - JÃºpiter: 3 horas, 3000 substeps
          - Saturno-Urano: 6 horas, 2000-1500 substeps
          - Neptuno: 12 horas, 1000 substeps

          ========================================
          EOF

      - name: Create ZIP package
        shell: bash
        run: |
          cd output/${{ matrix.os }}
          if [ "${{ matrix.os }}" = "windows" ]; then
            7z a -tzip ../../N-bodies-sim-${{ matrix.os }}.zip *
          else
            zip -r ../../N-bodies-sim-${{ matrix.os }}.zip *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: N-bodies-sim-${{ matrix.os }}
          path: N-bodies-sim-${{ matrix.os }}.zip
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate version tag
        id: version
        run: echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # N-Bodies Simulator - Solar System

          SimulaciÃ³n gravitatoria N-cuerpos del Sistema Solar con fÃ­sica realista.

          ## ğŸ“¦ Descargas

          Descarga el archivo correspondiente a tu sistema operativo:

          - **Windows**: `N-bodies-sim-windows.zip`
          - **Linux**: `N-bodies-sim-linux.zip`
          - **macOS**: `N-bodies-sim-macos.zip`

          ## ğŸš€ InstalaciÃ³n

          ### Windows
          1. Descarga y extrae el ZIP
          2. Ejecuta `N-bodies-sim.exe`

          ### Linux
          1. Descarga y extrae: `unzip N-bodies-sim-linux.zip`
          2. Da permisos: `chmod +x N-bodies-sim`
          3. Ejecuta: `./N-bodies-sim`

          ### macOS
          1. Descarga y extrae el ZIP
          2. Da permisos: `chmod +x N-bodies-sim`
          3. Ejecuta: `./N-bodies-sim`
          4. Si macOS bloquea: Preferencias del Sistema > Privacidad y Seguridad > "Abrir de todas formas"

          ## ğŸ® Controles

          - **ESPACIO**: Vista general del sistema solar
          - **0-9**: Seleccionar planeta (0=Sol, 1=Mercurio, 2=Venus, etc.)
          - **ESC**: Salir

          ## âš™ï¸ CaracterÃ­sticas

          - âœ… 9 planetas + Sol
          - âœ… 13 satÃ©lites naturales (Luna, Galileanos, TitÃ¡n, etc.)
          - âœ… Anillos planetarios (Saturno, Urano, Neptuno)
          - âœ… CinturÃ³n de asteroides y cinturÃ³n de Kuiper
          - âœ… Trazas orbitales
          - âœ… FÃ­sica gravitatoria N-cuerpos con integrador Euler
          - âœ… Timesteps adaptativos segÃºn el cuerpo observado

          ## ğŸ“‹ Requisitos

          - **Windows**: Windows 10/11 (64-bit)
          - **Linux**: GLIBC 2.31+ y drivers OpenGL
          - **macOS**: macOS 10.15+ (Catalina o superior)

          ## ğŸ“ Notas

          - Cada ejecutable incluye el runtime de .NET (~70 MB)
          - No requiere instalaciÃ³n de dependencias
          - El archivo `Data/astros.json` contiene los parÃ¡metros orbitales
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/N-bodies-sim-windows/N-bodies-sim-windows.zip
            artifacts/N-bodies-sim-linux/N-bodies-sim-linux.zip
            artifacts/N-bodies-sim-macos/N-bodies-sim-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
