name: Build Multi-Platform Release

on:
  workflow_dispatch: # ActivaciÃ³n manual desde GitHub Actions

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            runner: windows-latest
            rid: win-x64
            extension: .exe
          - os: linux
            runner: ubuntu-latest
            rid: linux-x64
            extension: ""
          - os: macos
            runner: macos-latest
            rid: osx-x64
            extension: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish self-contained executable
        shell: bash
        run: |
          dotnet publish NBodiesSim/NBodiesSim.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o output/${{ matrix.os }}

      - name: Copy Data folder
        shell: bash
        run: |
          mkdir -p output/${{ matrix.os }}/Data
          cp NBodiesSim/Data/astrosData.json output/${{ matrix.os }}/Data/
          cp NBodiesSim/Data/astrosConfig.json output/${{ matrix.os }}/Data/

      - name: Create README
        shell: bash
        run: |
          cat > output/${{ matrix.os }}/README.txt << 'EOF'
          ========================================
          N-Bodies Simulator - Solar System
          ========================================

          INSTRUCCIONES:

          1. AsegÃºrate de que la carpeta "Data" estÃ¡ en el mismo directorio que el ejecutable
          2. Ejecuta el programa:
             - Windows: Doble clic en NBodiesSim.exe
             - Linux/macOS: ./NBodiesSim (puede requerir: chmod +x NBodiesSim)

          CONTROLES:

          - ESPACIO: Vista general del sistema solar
          - 0-9: Seleccionar planeta/astro
          - ESC: Salir

          NOTA: Los archivos Data/astrosData.json y Data/astrosConfig.json contienen las posiciones,
          velocidades iniciales y configuraciones de todos los cuerpos celestes. Puedes editarlos
          para modificar la simulaciÃ³n.

          Timesteps usados (n = substeps de integraciÃ³n RK4):
          - Vista general: 12 horas (43200s), n=300
          - Sol: 12 horas (43200s), n=300
          - Mercurio: 1 hora (3600s), n=300
          - Venus: 1 hora (3600s), n=300
          - Tierra: 1 hora (3600s), n=300
          - Marte: 400 segundos (~7 min), n=300
          - JÃºpiter: 30 minutos (1800s), n=300
          - Saturno: 30 minutos (1800s), n=300
          - Urano: 1 hora (3600s), n=300
          - Neptuno: 1 hora (3600s), n=300
          - PlutÃ³n: 30 minutos (1800s), n=300

          MEJORAS RECIENTES (v1.3):
          - Timestep optimizado: Reducido de 1 dÃ­a a 12 horas en vistas generales
          - Estabilidad a largo plazo: SimulaciÃ³n validada durante 1,765+ aÃ±os simulados
          - PrecisiÃ³n orbital mejorada: Errores <0.4% vs valores teÃ³ricos
          - ConservaciÃ³n de energÃ­a: Error acumulado Â±1.89Ã—10â»â· (excelente)
          - Fobos estable: Ã“rbita se mantiene entre 9.25-9.40 millones de metros
          - Deimos ultra-estable: VariaciÃ³n de solo Â±486 metros

          ========================================
          EOF

      - name: Create ZIP package
        shell: bash
        run: |
          cd output/${{ matrix.os }}
          if [ "${{ matrix.os }}" = "windows" ]; then
            7z a -tzip ../../NBodiesSim-${{ matrix.os }}.zip *
          else
            zip -r ../../NBodiesSim-${{ matrix.os }}.zip *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NBodiesSim-${{ matrix.os }}
          path: NBodiesSim-${{ matrix.os }}.zip
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate version tag
        id: version
        run: echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # N-Bodies Simulator - Solar System

          SimulaciÃ³n gravitatoria N-cuerpos del Sistema Solar con fÃ­sica realista.

          ## ğŸ“¦ Descargas

          Descarga el archivo correspondiente a tu sistema operativo:

          - **Windows**: `NBodiesSim-windows.zip`
          - **Linux**: `NBodiesSim-linux.zip`
          - **macOS**: `NBodiesSim-macos.zip`

          ## ğŸš€ InstalaciÃ³n

          ### Windows
          1. Descarga y extrae el ZIP
          2. Ejecuta `NBodiesSim.exe`

          ### Linux
          1. Descarga y extrae: `unzip NBodiesSim-linux.zip`
          2. Da permisos: `chmod +x NBodiesSim`
          3. Ejecuta: `./NBodiesSim`

          ### macOS
          1. Descarga y extrae el ZIP
          2. Da permisos: `chmod +x NBodiesSim`
          3. Ejecuta: `./NBodiesSim`
          4. Si macOS bloquea: Preferencias del Sistema > Privacidad y Seguridad > "Abrir de todas formas"

          ## ğŸ® Controles

          - **ESPACIO**: Vista general del sistema solar
          - **0-9**: Seleccionar planeta (0=Sol, 1=Mercurio, 2=Venus, etc.)
          - **ESC**: Salir

          ## âš™ï¸ CaracterÃ­sticas

          - âœ… 8 planetas + Sol + objetos del CinturÃ³n de Kuiper
          - âœ… 13+ satÃ©lites naturales (Luna, Galileanos, TitÃ¡n, etc.)
          - âœ… FÃ­sica gravitatoria N-cuerpos completa con Runge-Kutta 4 (RK4)
          - âœ… Anillos planetarios (Saturno, Urano, Neptuno)
          - âœ… CinturÃ³n de asteroides y cinturÃ³n de Kuiper
          - âœ… Trazas orbitales optimizadas (1.5-3 Ã³rbitas) con gradiente de transparencia
          - âœ… Timesteps adaptativos segÃºn el cuerpo observado
          - âœ… Monitor de conservaciÃ³n de energÃ­a con error acumulado en tiempo real
          - âœ… 10,000 estrellas de fondo generadas proceduralmente
          - âœ… Rendimiento optimizado: 60 FPS estables incluso despuÃ©s de horas

          ## ğŸ”¥ Mejoras Recientes (v1.3)

          ### OptimizaciÃ³n de Timestep y Estabilidad a Largo Plazo
          - **Timestep reducido**: De 1 dÃ­a (86400s) a 12 horas (43200s) en vistas generales
          - **Estabilidad dramÃ¡tica**: SimulaciÃ³n validada durante **1,765+ aÃ±os simulados** sin colapsos
          - **Mejora 3.7Ã—**: Comparado con versiÃ³n anterior (468 aÃ±os antes de inestabilidad)
          - **Fobos estable**: Ã“rbita se mantiene entre 9.25-9.40 millones de metros
          - **Deimos ultra-estable**: VariaciÃ³n orbital de solo Â±486 metros en 1,765 aÃ±os
          - **PrecisiÃ³n orbital**: Velocidades orbitales <0.4% error vs teorÃ­a
          - **ConservaciÃ³n de energÃ­a**: Error acumulado Â±1.89Ã—10â»â· (excelente para simulaciÃ³n N-body)
          - **ProyecciÃ³n caracterizada**: Fobos decae ~69 m/aÃ±o (47,000 aÃ±os hasta lÃ­mite de Roche)

          ### Versiones Anteriores
          - **v1.2**: CorrecciÃ³n de posiciones de Fobos/Deimos, monitoreo de energÃ­a
          - **v1.1**: CorrecciÃ³n crÃ­tica de trazas orbitales, optimizaciÃ³n de rendimiento

          ## âš ï¸ Limitaciones Conocidas

          - **Decay orbital lento**: Fobos muestra decaimiento de ~69 m/aÃ±o por acumulaciÃ³n numÃ©rica
          - **Causa**: Errores numÃ©ricos + condiciones iniciales no realistas (cuerpos alineados)
          - **Impacto**: MÃ­nimo - tomarÃ­a ~47,000 aÃ±os simulados para efectos significativos
          - **MitigaciÃ³n futura**: IntegraciÃ³n con datos reales de NASA JPL Horizons eliminarÃ¡ este artefacto

          ## ğŸ“‹ Requisitos

          - **Windows**: Windows 10/11 (64-bit)
          - **Linux**: GLIBC 2.31+ y drivers OpenGL
          - **macOS**: macOS 10.15+ (Catalina o superior)

          ## ğŸ“ Notas

          - Cada ejecutable incluye el runtime de .NET (~70 MB)
          - No requiere instalaciÃ³n de dependencias
          - Los archivos `Data/astrosData.json` y `Data/astrosConfig.json` contienen los parÃ¡metros orbitales y configuraciones de cÃ¡mara
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/NBodiesSim-windows/NBodiesSim-windows.zip
            artifacts/NBodiesSim-linux/NBodiesSim-linux.zip
            artifacts/NBodiesSim-macos/NBodiesSim-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
