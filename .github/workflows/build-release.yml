name: Build Multi-Platform Release

on:
  workflow_dispatch: # ActivaciÃ³n manual desde GitHub Actions

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: windows
            runner: windows-latest
            rid: win-x64
            extension: .exe
          - os: linux
            runner: ubuntu-latest
            rid: linux-x64
            extension: ""
          - os: macos
            runner: macos-latest
            rid: osx-x64
            extension: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish self-contained executable
        shell: bash
        run: |
          dotnet publish NBodiesSim/NBodiesSim.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o output/${{ matrix.os }}

      - name: Copy Data folder
        shell: bash
        run: |
          mkdir -p output/${{ matrix.os }}/Data
          cp NBodiesSim/Data/astrosData.json output/${{ matrix.os }}/Data/
          cp NBodiesSim/Data/astrosConfig.json output/${{ matrix.os }}/Data/

      - name: Create README
        shell: bash
        run: |
          cat > output/${{ matrix.os }}/README.txt << 'EOF'
          ========================================
          N-Bodies Simulator - Solar System
          ========================================

          INSTRUCCIONES:

          1. AsegÃºrate de que la carpeta "Data" estÃ¡ en el mismo directorio que el ejecutable
          2. Ejecuta el programa:
             - Windows: Doble clic en NBodiesSim.exe
             - Linux/macOS: ./NBodiesSim (puede requerir: chmod +x NBodiesSim)

          CONTROLES:

          - ESPACIO: Vista general del sistema solar
          - 0-9: Seleccionar planeta/astro
          - ESC: Salir

          NOTA: Los archivos Data/astrosData.json y Data/astrosConfig.json contienen las posiciones,
          velocidades iniciales y configuraciones de todos los cuerpos celestes. Puedes editarlos
          para modificar la simulaciÃ³n.

          Timesteps usados (n = substeps de integraciÃ³n RK4):
          - Vista general: 1 dÃ­a (86400s), n=300
          - Sol: 1 dÃ­a (86400s), n=300
          - Mercurio: 1 hora (3600s), n=300
          - Venus: 1 hora (3600s), n=300
          - Tierra: 1 hora (3600s), n=300
          - Marte: 400 segundos (~7 min), n=300
          - JÃºpiter: 30 minutos (1800s), n=300
          - Saturno: 30 minutos (1800s), n=300
          - Urano: 1 hora (3600s), n=300
          - Neptuno: 1 hora (3600s), n=300

          OPTIMIZACIONES:
          - Trazas orbitales optimizadas: 1.5-3 Ã³rbitas segÃºn distancia
          - Bug crÃ­tico corregido: colas de trazas ahora se limpian correctamente
          - Rendimiento estable: 60 FPS incluso despuÃ©s de horas de simulaciÃ³n
          - SatÃ©lites Fobos/Deimos: Ã³rbitas cinemÃ¡ticas para estabilidad

          ========================================
          EOF

      - name: Create ZIP package
        shell: bash
        run: |
          cd output/${{ matrix.os }}
          if [ "${{ matrix.os }}" = "windows" ]; then
            7z a -tzip ../../NBodiesSim-${{ matrix.os }}.zip *
          else
            zip -r ../../NBodiesSim-${{ matrix.os }}.zip *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NBodiesSim-${{ matrix.os }}
          path: NBodiesSim-${{ matrix.os }}.zip
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate version tag
        id: version
        run: echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # N-Bodies Simulator - Solar System

          SimulaciÃ³n gravitatoria N-cuerpos del Sistema Solar con fÃ­sica realista.

          ## ğŸ“¦ Descargas

          Descarga el archivo correspondiente a tu sistema operativo:

          - **Windows**: `NBodiesSim-windows.zip`
          - **Linux**: `NBodiesSim-linux.zip`
          - **macOS**: `NBodiesSim-macos.zip`

          ## ğŸš€ InstalaciÃ³n

          ### Windows
          1. Descarga y extrae el ZIP
          2. Ejecuta `NBodiesSim.exe`

          ### Linux
          1. Descarga y extrae: `unzip NBodiesSim-linux.zip`
          2. Da permisos: `chmod +x NBodiesSim`
          3. Ejecuta: `./NBodiesSim`

          ### macOS
          1. Descarga y extrae el ZIP
          2. Da permisos: `chmod +x NBodiesSim`
          3. Ejecuta: `./NBodiesSim`
          4. Si macOS bloquea: Preferencias del Sistema > Privacidad y Seguridad > "Abrir de todas formas"

          ## ğŸ® Controles

          - **ESPACIO**: Vista general del sistema solar
          - **0-9**: Seleccionar planeta (0=Sol, 1=Mercurio, 2=Venus, etc.)
          - **ESC**: Salir

          ## âš™ï¸ CaracterÃ­sticas

          - âœ… 8 planetas + Sol + objetos del CinturÃ³n de Kuiper
          - âœ… 13+ satÃ©lites naturales (Luna, Galileanos, TitÃ¡n, etc.)
          - âœ… Sistema de fÃ­sica hÃ­brido: N-body completo + Ã³rbitas cinemÃ¡ticas para satÃ©lites rÃ¡pidos
          - âœ… Anillos planetarios (Saturno, Urano, Neptuno)
          - âœ… CinturÃ³n de asteroides y cinturÃ³n de Kuiper
          - âœ… Trazas orbitales optimizadas (1.5-3 Ã³rbitas) con gradiente de transparencia
          - âœ… FÃ­sica gravitatoria N-cuerpos con Runge-Kutta 4 (RK4)
          - âœ… Timesteps adaptativos segÃºn el cuerpo observado
          - âœ… Monitor de conservaciÃ³n de energÃ­a en tiempo real (drift < 10â»â·)
          - âœ… 10,000 estrellas de fondo generadas proceduralmente
          - âœ… Rendimiento optimizado: 60 FPS estables incluso despuÃ©s de horas

          ## ğŸ”¥ Mejoras Recientes (v1.1)

          - **Bug crÃ­tico corregido**: Colas de trazas ahora se limpian correctamente (eliminaba solo 1 punto/frame)
          - **Sin degradaciÃ³n de FPS**: Mantiene 60 FPS estables durante toda la sesiÃ³n
          - **Trazas optimizadas**: 25-40% menos puntos sin perder capacidad de ver perturbaciones orbitales
          - **Sistema hÃ­brido**: Phobos/Deimos con MCU para estabilidad orbital perfecta

          ## âš ï¸ Problemas Conocidos

          - Quaoar puede derivar de su Ã³rbita en el CinturÃ³n de Kuiper (timestep grande para distancia lejana)
          - Fobos puede escapar en configuraciones especÃ­ficas de hardware (bajo investigaciÃ³n)

          ## ğŸ“‹ Requisitos

          - **Windows**: Windows 10/11 (64-bit)
          - **Linux**: GLIBC 2.31+ y drivers OpenGL
          - **macOS**: macOS 10.15+ (Catalina o superior)

          ## ğŸ“ Notas

          - Cada ejecutable incluye el runtime de .NET (~70 MB)
          - No requiere instalaciÃ³n de dependencias
          - Los archivos `Data/astrosData.json` y `Data/astrosConfig.json` contienen los parÃ¡metros orbitales y configuraciones de cÃ¡mara
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/NBodiesSim-windows/NBodiesSim-windows.zip
            artifacts/NBodiesSim-linux/NBodiesSim-linux.zip
            artifacts/NBodiesSim-macos/NBodiesSim-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
